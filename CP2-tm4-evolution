import numpy as np
import matplotlib.pyplot as plt
import pandas as pd
from scipy.optimize import differential_evolution
import seaborn as sns


class EvolutionaryMethodsAnalysis:
    def __init__(self):
        self.students_data = None
        self.generate_student_data()
        self.setup_style()

    def setup_style(self):
        """–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å—Ç–∏–ª—é –≥—Ä–∞—Ñ—ñ–∫—ñ–≤"""
        plt.rcParams['font.family'] = 'DejaVu Sans'
        sns.set_palette("husl")

    def generate_student_data(self):
        """–ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤"""
        np.random.seed(42)
        n_students = 100

        self.students_data = pd.DataFrame({
            'study_hours': np.random.normal(15, 5, n_students),
            'attendance_rate': np.random.normal(85, 10, n_students),
            'add_courses': np.random.normal(12, 5, n_students),
            'satisfaction': np.random.normal(7, 2, n_students)
        })

        self.students_data['exam_score'] = (
                0.4 * self.students_data['study_hours'] +
                0.3 * self.students_data['attendance_rate'] +
                0.2 * self.students_data['add_courses'] +
                0.1 * self.students_data['satisfaction'] +
                np.random.normal(0, 5, n_students)
        )

    def objective_function(self, params):
        """–¶—ñ–ª—å–æ–≤–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó"""
        X = self.students_data[['study_hours', 'attendance_rate', 'add_courses', 'satisfaction']].values
        y = self.students_data['exam_score'].values

        predictions = X @ params
        mse = np.mean((predictions - y) ** 2)
        regularization = 0.01 * np.sum(params ** 2)

        return mse + regularization

    def compare_evolutionary_vs_traditional(self):
        """–ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –µ–≤–æ–ª—é—Ü—ñ–π–Ω–∏—Ö –º–µ—Ç–æ–¥—ñ–≤ –∑ —Ç—Ä–∞–¥–∏—Ü—ñ–π–Ω–∏–º–∏"""
        print("\n" + "=" * 70)
        print("üß¨ –ü–û–†–Ü–í–ù–Ø–ù–ù–Ø –ï–í–û–õ–Æ–¶–Ü–ô–ù–ò–• –ú–ï–¢–û–î–Ü–í –ó –¢–†–ê–î–ò–¶–Ü–ô–ù–ò–ú–ò")
        print("=" * 70)

        bounds = [(-10, 10)] * 4

        fig, axes = plt.subplots(2, 2, figsize=(15, 12))
        fig.suptitle('üß¨ –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –µ–≤–æ–ª—é—Ü—ñ–π–Ω–∏—Ö —Ç–∞ —Ç—Ä–∞–¥–∏—Ü—ñ–π–Ω–∏—Ö –º–µ—Ç–æ–¥—ñ–≤ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó',
                     fontsize=16, fontweight='bold')

        # 1. –î—ñ–∞–≥—Ä–∞–º–∞ –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –º–µ—Ç–æ–¥—ñ–≤
        methods_comparison = {
            '–ú–µ—Ç–æ–¥': ['–ì–µ–Ω–µ—Ç–∏—á–Ω—ñ –∞–ª–≥–æ—Ä–∏—Ç–º–∏', '–î–∏—Ñ–µ—Ä–µ–Ω—Ü—ñ–π–Ω–∞ –µ–≤–æ–ª—é—Ü—ñ—è', '–†–æ—î–≤–∞ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è',
                      '–ì—Ä–∞–¥—ñ—î–Ω—Ç–Ω–∏–π —Å–ø—É—Å–∫', '–ù—å—é—Ç–æ–Ω', 'BFGS'],
            '–¢–∏–ø': ['–ï–≤–æ–ª—é—Ü—ñ–π–Ω–∏–π', '–ï–≤–æ–ª—é—Ü—ñ–π–Ω–∏–π', '–ï–≤–æ–ª—é—Ü—ñ–π–Ω–∏–π',
                    '–ì—Ä–∞–¥—ñ—î–Ω—Ç–Ω–∏–π', '–ì—Ä–∞–¥—ñ—î–Ω—Ç–Ω–∏–π', '–ì—Ä–∞–¥—ñ—î–Ω—Ç–Ω–∏–π'],
            '–ì–ª–æ–±–∞–ª—å–Ω–∏–π –ø–æ—à—É–∫': ['–¢–∞–∫', '–¢–∞–∫', '–¢–∞–∫', '–ù—ñ', '–ù—ñ', '–ù—ñ'],
            '–ü–æ—Ö—ñ–¥–Ω—ñ': ['–ù–µ –ø–æ—Ç—Ä—ñ–±–Ω—ñ', '–ù–µ –ø–æ—Ç—Ä—ñ–±–Ω—ñ', '–ù–µ –ø–æ—Ç—Ä—ñ–±–Ω—ñ', '–ü–æ—Ç—Ä—ñ–±–Ω—ñ', '–ü–æ—Ç—Ä—ñ–±–Ω—ñ', '–ü–æ—Ç—Ä—ñ–±–Ω—ñ']
        }

        df_comparison = pd.DataFrame(methods_comparison)

        # –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è
        sns.heatmap(pd.get_dummies(df_comparison.set_index('–ú–µ—Ç–æ–¥')),
                    ax=axes[0, 0], cmap=['lightcoral', 'lightgreen'],
                    cbar_kws={'label': '–¢–∞–∫/–ù—ñ'})
        axes[0, 0].set_title('–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –º–µ—Ç–æ–¥—ñ–≤ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó')

        # 2. –ï–≤–æ–ª—é—Ü—ñ–π–Ω—ñ –º–µ—Ç–æ–¥–∏
        evolutionary_methods = [
            "–ì–µ–Ω–µ—Ç–∏—á–Ω—ñ –∞–ª–≥–æ—Ä–∏—Ç–º–∏ (GA)",
            "–î–∏—Ñ–µ—Ä–µ–Ω—Ü—ñ–π–Ω–∞ –µ–≤–æ–ª—é—Ü—ñ—è (DE)",
            "–ï–≤–æ–ª—é—Ü—ñ–π–Ω—ñ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—ó (ES)",
            "–ì–µ–Ω–µ—Ç–∏—á–Ω–µ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è (GP)",
            "–†–æ—î–≤–∞ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è (PSO)",
            "–ê–ª–≥–æ—Ä–∏—Ç–º –º—É—Ä–∞—à–∏–Ω–∏—Ö –∫–æ–ª–æ–Ω—ñ–π (ACO)"
        ]

        axes[0, 1].axis('off')
        axes[0, 1].text(0.1, 0.9, '–ï–í–û–õ–Æ–¶–Ü–ô–ù–Ü –ú–ï–¢–û–î–ò –û–ü–¢–ò–ú–Ü–ó–ê–¶–Ü–á',
                        fontsize=14, fontweight='bold')
        for i, method in enumerate(evolutionary_methods):
            axes[0, 1].text(0.1, 0.8 - i * 0.1, method, fontsize=11)

        # 3. –ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –º–µ—Ç–æ–¥—ñ–≤
        from scipy.optimize import minimize

        # –î–∏—Ñ–µ—Ä–µ–Ω—Ü—ñ–π–Ω–∞ –µ–≤–æ–ª—é—Ü—ñ—è
        result_de = differential_evolution(self.objective_function, bounds,
                                           strategy='best1bin', maxiter=50,
                                           popsize=20, disp=False)

        # –ì—Ä–∞–¥—ñ—î–Ω—Ç–Ω–∏–π –º–µ—Ç–æ–¥
        result_bfgs = minimize(self.objective_function, np.zeros(4),
                               method='BFGS', options={'disp': False})

        methods_performance = {
            '–ú–µ—Ç–æ–¥': ['–î–∏—Ñ–µ—Ä–µ–Ω—Ü—ñ–π–Ω–∞ –µ–≤–æ–ª—é—Ü—ñ—è', 'BFGS'],
            '–§—É–Ω–∫—Ü—ñ—è –≤—Ç—Ä–∞—Ç': [result_de.fun, result_bfgs.fun],
            '–û—Ü—ñ–Ω–∫–∞': ['–ì–ª–æ–±–∞–ª—å–Ω–∏–π –ø–æ—à—É–∫', '–õ–æ–∫–∞–ª—å–Ω–∏–π –ø–æ—à—É–∫']
        }

        df_perf = pd.DataFrame(methods_performance)
        bars = axes[1, 0].bar(df_perf['–ú–µ—Ç–æ–¥'], df_perf['–§—É–Ω–∫—Ü—ñ—è –≤—Ç—Ä–∞—Ç'],
                              color=['lightblue', 'lightcoral'])
        axes[1, 0].set_ylabel('–§—É–Ω–∫—Ü—ñ—è –≤—Ç—Ä–∞—Ç')
        axes[1, 0].set_title('–ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –º–µ—Ç–æ–¥—ñ–≤')

        for bar, value in zip(bars, df_perf['–§—É–Ω–∫—Ü—ñ—è –≤—Ç—Ä–∞—Ç']):
            axes[1, 0].text(bar.get_x() + bar.get_width() / 2, bar.get_height() + 0.001,
                            f'{value:.4f}', ha='center', va='bottom')

        # 4. –ü–µ—Ä–µ–≤–∞–≥–∏ —Ç–∞ –Ω–µ–¥–æ–ª—ñ–∫–∏
        advantages = [
            "+ –ì–ª–æ–±–∞–ª—å–Ω–∏–π –ø–æ—à—É–∫ –æ–ø—Ç–∏–º—É–º—É",
            "+ –ù–µ –≤–∏–º–∞–≥–∞—î –ø–æ—Ö—ñ–¥–Ω–∏—Ö",
            "+ –°—Ç—ñ–π–∫—ñ—Å—Ç—å –¥–æ —à—É–º—É",
            "+ –ü—Ä–∞—Ü—é—î –∑ –Ω–µ–¥–∏—Ñ–µ—Ä–µ–Ω—Ü—ñ–π–æ–≤–∞–Ω–∏–º–∏ —Ñ—É–Ω–∫—Ü—ñ—è–º–∏",
            "- –ü–æ–≤—ñ–ª—å–Ω–∞ –∑–±—ñ–∂–Ω—ñ—Å—Ç—å",
            "- –í–µ–ª–∏–∫–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –æ–±—á–∏—Å–ª–µ–Ω—å",
            "- –°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤"
        ]

        axes[1, 1].axis('off')
        axes[1, 1].text(0.1, 0.9, '–ü–ï–†–ï–í–ê–ì–ò –¢–ê –ù–ï–î–û–õ–Ü–ö–ò –ï–í–û–õ–Æ–¶–Ü–ô–ù–ò–• –ú–ï–¢–û–î–Ü–í',
                        fontsize=12, fontweight='bold')
        for i, item in enumerate(advantages):
            color = 'green' if '+' in item else 'red'
            axes[1, 1].text(0.1, 0.8 - i * 0.08, item, fontsize=10, color=color)

        plt.tight_layout()
        plt.show()

        print("\n–†–ï–ó–£–õ–¨–¢–ê–¢–ò –ü–û–†–Ü–í–ù–Ø–ù–ù–Ø:")
        print(f"–î–∏—Ñ–µ—Ä–µ–Ω—Ü—ñ–π–Ω–∞ –µ–≤–æ–ª—é—Ü—ñ—è: {result_de.fun:.6f}")
        print(f"BFGS: {result_bfgs.fun:.6f}")


# –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª—ñ–∑—É
if __name__ == "__main__":
    print("–ú–û–ù–Ü–¢–û–†–ò–ù–ì –ù–ê–í–ß–ê–õ–¨–ù–ò–• –î–û–°–Ø–ì–ù–ï–ù–¨ –°–¢–£–î–ï–ù–¢–Ü–í")
    print("–ê–ù–ê–õ–Ü–ó –ï–í–û–õ–Æ–¶–Ü–ô–ù–ò–ú–ò –ú–ï–¢–û–î–ê–ú–ò")

    analysis = EvolutionaryMethodsAnalysis()
    analysis.compare_evolutionary_vs_traditional()
